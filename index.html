<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>æ‰“ç£šå¡Š</title>
<style>
body {
    margin: 0;
    background: #222;
    color: #fff;
    text-align: center;
    font-family: Arial;
    touch-action: none;
}
canvas {
    background: #000;
    display: block;
    margin: 8px auto;
    border: 2px solid #fff;
}
button {
    padding: 12px 24px;
    margin: 6px;
    font-size: 16px;
}
</style>
</head>
<body>

<h2>æ‰“ç£šå¡Š</h2>

<div id="menu">
    <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
    <button onclick="restartGame()">å†ä¾†ä¸€å±€</button>
    <button onclick="showHighScores()">æŸ¥çœ‹é«˜åˆ†</button>
</div>

<div id="highScorePanel" style="display:none;">
    <h3>ğŸ† é«˜åˆ†æ¦œ</h3>
    <ol id="highScoreList"></ol>
    <button onclick="backToMenu()">è¿”å›é¸å–®</button>
</div>

<canvas id="game" style="display:none;"></canvas>
<p id="info"></p>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* ---------- è‡ªé©æ‡‰ ---------- */
function resizeCanvas() {
    const maxWidth = 500;
    const w = Math.min(window.innerWidth - 16, maxWidth);
    canvas.width = w;
    canvas.height = Math.floor(w * 1.4);
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ---------- éŠæˆ²ç‹€æ…‹ ---------- */
let score = 0;
let lives = 3;
let ballLaunched = false;
let gameOver = false;
let animationId;
let level = 1;

/* ---------- å¹³å° ---------- */
const paddle = {
    width: 0,
    height: 12,
    x: 0,
    vx: 0,
    accel: 0.8,
    maxSpeed: 8,
    friction: 0.85
};

/* ---------- çƒ ---------- */
const ball = {
    x: 0, y: 0,
    prevX: 0, prevY: 0,
    r: 8,
    dx: 0, dy: 0
};

/* ---------- ç‰©ç† ---------- */
const maxBounceAngle = 60;
const baseBallSpeed = 5;

/* ---------- ç£šå¡Š ---------- */
let brickRow = 5;
let brickCol = 6;
const brickOffsetTop = 50;
let brickWidth, brickHeight = 22;
let brickGap;
let bricks = [];

/* ---------- è¼¸å…¥ ---------- */
let leftPressed = false;
let rightPressed = false;

/* ---------- é«˜åˆ† ---------- */
function saveHighScore(s) {
    let scores = getHighScores();
    scores.push(s);
    scores.sort((a,b)=>b-a);
    localStorage.setItem("brickHighScores", JSON.stringify(scores.slice(0,5)));
}
function getHighScores() {
    return JSON.parse(localStorage.getItem("brickHighScores")) || [];
}

/* ---------- é¸å–® ---------- */
function startGame() {
    document.getElementById("menu").style.display="none";
    document.getElementById("highScorePanel").style.display="none";
    canvas.style.display="block";
    level = 1;
    initGame();
}
function restartGame() {
    cancelAnimationFrame(animationId);
    startGame();
}
function backToMenu() {
    document.getElementById("highScorePanel").style.display="none";
    document.getElementById("menu").style.display="block";
}
function showHighScores() {
    const list = document.getElementById("highScoreList");
    list.innerHTML="";
    getHighScores().forEach(s=>{
        const li = document.createElement("li");
        li.textContent = s;
        list.appendChild(li);
    });
    document.getElementById("menu").style.display="none";
    document.getElementById("highScorePanel").style.display="block";
}

/* ---------- åˆå§‹åŒ– ---------- */
function initGame() {
    if(level===1){
        score = 0;
        lives = 3;
    }
    gameOver = false;

    paddle.width = canvas.width * 0.25;
    paddle.x = canvas.width/2 - paddle.width/2;
    paddle.vx = 0;

    brickWidth = canvas.width / (brickCol*2+1);
    brickGap = brickWidth;

    createBricks();
    resetBall();
    draw();
}

/* ---------- å»ºç«‹ç£šå¡Š ---------- */
function createBricks() {
    bricks=[];
    for(let r=0;r<brickRow;r++){
        bricks[r]=[];
        for(let c=0;c<brickCol;c++){
            let type="normal";
            if(level===1 && r===Math.floor(brickRow/2)) type="topOnly";
            if(level>1 && r===Math.floor(brickRow/2)){
                // éš¨æ©Ÿç‰¹æ®Šç£š
                type = Math.random()<0.5?"topOnly":"normal";
            }
            bricks[r][c]={x:0,y:0,hp:1,type};
        }
    }
}

/* ---------- çƒ ---------- */
function resetBall() {
    ballLaunched=false;
    ball.dx=0; ball.dy=0;
}

function launchBall() {
    if(ballLaunched||gameOver) return;
    ball.dx=0;
    ball.dy=-baseBallSpeed;
    ballLaunched=true;
}

/* ---------- éµç›¤ ---------- */
document.addEventListener("keydown",e=>{
    if(e.code==="ArrowLeft") leftPressed=true;
    if(e.code==="ArrowRight") rightPressed=true;
    if(e.code==="Space") launchBall();
});
document.addEventListener("keyup",e=>{
    if(e.code==="ArrowLeft") leftPressed=false;
    if(e.code==="ArrowRight") rightPressed=false;
});

/* ---------- ç¢°æ’ ---------- */
function collisionDetection(){
    let remaining=0;
    for(let r=0;r<brickRow;r++){
        for(let c=0;c<brickCol;c++){
            const b=bricks[r][c];
            if(b.hp<=0) continue;
            remaining++;

            const closestX=Math.max(b.x, Math.min(ball.x,b.x+brickWidth));
            const closestY=Math.max(b.y, Math.min(ball.y,b.y+brickHeight));
            const dx=ball.x-closestX;
            const dy=ball.y-closestY;

            if(dx*dx+dy*dy<ball.r*ball.r){
                const hitFromTop = ball.prevY+ball.r<=b.y;
                if(b.type==="topOnly"&&!hitFromTop){ ball.dy*=-1; return; }

                if(Math.abs(dx)>Math.abs(dy)) ball.dx*=-1;
                else ball.dy*=-1;

                b.hp--;
                score++;
                return;
            }
        }
    }
    if(remaining===0){
        // ä¸‹ä¸€é—œ
        level++;
        createBricks();
        resetBall();
    }
}

/* ---------- ç¹ªåœ– ---------- */
function drawBricks(){
    for(let r=0;r<brickRow;r++){
        for(let c=0;c<brickCol;c++){
            const b=bricks[r][c];
            if(b.hp<=0) continue;

            const x=brickGap + c*(brickWidth+brickGap);
            const y=brickOffsetTop + r*(brickHeight+12);
            b.x=x; b.y=y;

            if(b.type==="topOnly"){
                ctx.fillStyle="#cc3333";
                ctx.fillRect(x,y,brickWidth,brickHeight);
                ctx.fillStyle="#cccccc";
                ctx.fillRect(x,y+brickHeight-4,brickWidth,4);
            }else{
                ctx.fillStyle="#ffaa33";
                ctx.fillRect(x,y,brickWidth,brickHeight);
            }
        }
    }
}

function drawBall(){
    ctx.beginPath();
    ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);
    ctx.fillStyle="#00ffcc";
    ctx.fill();
}

function drawPaddle(){
    ctx.fillStyle="#fff";
    ctx.fillRect(paddle.x,canvas.height-paddle.height-10,paddle.width,paddle.height);
}

/* ---------- ä¸»è¿´åœˆ ---------- */
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    drawBricks();
    drawBall();
    drawPaddle();
    collisionDetection();

    // çƒç‰†å£
    if(ball.x<ball.r||ball.x>canvas.width-ball.r) ball.dx*=-1;
    if(ball.y<ball.r) ball.dy*=-1;

    // å¹³å°æ…£æ€§
    if(leftPressed) paddle.vx-=paddle.accel;
    if(rightPressed) paddle.vx+=paddle.accel;
    paddle.vx*=paddle.friction;
    paddle.vx=Math.max(-paddle.maxSpeed, Math.min(paddle.vx,paddle.maxSpeed));
    paddle.x+=paddle.vx;
    paddle.x=Math.max(0, Math.min(paddle.x,canvas.width-paddle.width));

    const paddleTop=canvas.height-paddle.height-10;

    // æ¥çƒåˆ¤å®š
    if(ball.dy>0 && ball.prevY+ball.r<=paddleTop && ball.y+ball.r>=paddleTop &&
       ball.x>=paddle.x && ball.x<=paddle.x+paddle.width){
        let hit=(ball.x-(paddle.x+paddle.width/2))/(paddle.width/2);
        hit=Math.max(-1,Math.min(hit,1));
        let rad=hit*maxBounceAngle*Math.PI/180;
        ball.dx=baseBallSpeed*Math.sin(rad);
        ball.dy=-baseBallSpeed*Math.cos(rad);
        ball.y=paddleTop-ball.r;
    }

    // å‡ºå±€åˆ¤å®š
    if(ball.y-ball.r>canvas.height){
        lives--;
        if(lives<=0){
            gameOver=true;
            canvas.style.display="none";
            document.getElementById("menu").style.display="block";
            saveHighScore(score);
        }else{
            resetBall();
        }
    }

    if(!ballLaunched&&!gameOver){
        ball.x=paddle.x+paddle.width/2;
        ball.y=paddleTop-ball.r;
    }else if(ballLaunched){
        ball.prevX=ball.x;
        ball.prevY=ball.y;
        ball.x+=ball.dx;
        ball.y+=ball.dy;
    }

    document.getElementById("info").innerText=
        gameOver ? `GAME OVERï½œåˆ†æ•¸ ${score}` : `é—œå¡ ${level} ï½œ åˆ†æ•¸ ${score} ï½œ å‰©é¤˜çƒæ•¸ ${lives}`;

    animationId=requestAnimationFrame(draw);
}
</script>
</body>
</html>
